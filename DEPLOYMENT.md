# Deployment Guide

## Overview

This application runs on **AWS Elastic Beanstalk** using a **Docker container** built from a custom base image
`jaylordibe/laravel-api`, which already includes:

- PHP-FPM (for handling web requests)
- Laravel Horizon (for processing queues)

The deployment is **fully automated** via **GitHub Actions**.

---

## Environment Overview

- **Platform:** Docker (Amazon Linux 2)
- **Single Environment:** Handles both web requests and queue jobs.
- **Supervisor:** Already configured in the base image to run:
    - `php-fpm` (API)
    - `php artisan horizon` (queue worker)
- **Database:** AWS RDS (MySQL)
- **Cache/Queue:** AWS ElastiCache (Redis)

---

## One-Time Setup (Admin Only)

These steps are **done once** and are not required for routine deployments.

### 1. Provision Elastic Beanstalk App & Environment

- Deploy the CloudFormation template [`eb-laravel-api-env.yaml`](./eb-laravel-api-env.yaml) via AWS Console:
    - Go to **AWS Console → CloudFormation**.
    - Click **Create stack → With new resources (standard)**.
    - Upload `eb-laravel-api-env.yaml`.
    - Wait until stack creation is complete.
- This creates:
    - **EB Application:** `laravel-api`
    - **EB Environment:** `laravel-api-web`

### 2. Add Environment Variables (after RDS & ElastiCache exist)

- Go to **AWS Console → Elastic Beanstalk → laravel-api-web → Configuration → Software**.
- Add/update the following environment variables:
    - `APP_ENV`: `production`
    - `APP_KEY`: Generated by `php artisan key:generate`
    - `DB_CONNECTION`: `mysql`
    - `DB_HOST`: RDS endpoint
    - `DB_PORT`: `3306`
    - `DB_DATABASE`: Database name
    - `DB_USERNAME`: Database username
    - `DB_PASSWORD`: Database password
    - `REDIS_HOST`: ElastiCache endpoint
    - `REDIS_PORT`: `6379`
    - `REDIS_PASSWORD`: ElastiCache password
    - `QUEUE_CONNECTION`: `redis`
- Save and restart the environment.

---

## Regular Deployment (Developers)

> **Goal:** Automatically build and deploy code changes to AWS on every push/merge to `main`.

### Steps

1. Commit and push code to the `main` branch.
2. GitHub Actions pipeline runs automatically:
    - Packages source code (excluding ignored files via `.ebignore`).
    - Deploys to AWS Elastic Beanstalk using the GitHub
      Action [beanstalk-deploy](https://github.com/einaregilsson/beanstalk-deploy).
    - Runs database migrations automatically (via `.ebextensions/01_migrate.config`).
3. Deployment complete:
    - EB restarts containers with the latest code.
    - Supervisor starts both `php-fpm` and `php artisan horizon`.

---

## Key Files

- **`Dockerfile`**
    - Builds the Laravel application on top of the custom base image **`jaylordibe/laravel-api`**.
    - Defines how the application container is built for deployment on AWS Elastic Beanstalk.

- **`.ebextensions/01_migrate.config`**
    - Ensures database migrations are automatically run during each deployment using Elastic Beanstalk container
      commands.

- **`.ebignore`**
    - Reduces deployment size by excluding unnecessary files and directories from the Elastic Beanstalk deployment
      package.

- **`.dockerignore`**
    - Optimizes the Docker build context by excluding unnecessary files and directories, resulting in faster Docker
      builds.

- **`.github/workflows/deploy-to-aws-eb.yaml`**
    - Defines the GitHub Actions CI/CD pipeline:
        - Packages the application code.
        - Deploys automatically to AWS Elastic Beanstalk on every push to the `main` branch.
        - Ensures zero-downtime rolling deployments.

- **`eb-laravel-api-env.yaml`**
    - AWS CloudFormation template used to provision the Elastic Beanstalk application and a single environment for
      cost-optimized deployment.
    - Run once to create the application and environment in AWS.
